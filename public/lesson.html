<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Journalism Course - Lesson</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lesson-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        .lesson-panel {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .coding-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100%;
            overflow: hidden;
        }

        .editor-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .editor-header {
            background: #2d3748;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .tab {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .tab.active {
            background: rgba(255,255,255,0.2);
        }

        .tab-label {
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: #357ae8;
        }

        .action-btn.success {
            background: #34a853;
        }

        .action-btn.danger {
            background: #ea4335;
        }

        .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #monaco-editor {
            flex: 1;
            width: 100%;
            min-height: 0;
        }

        .preview-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: 280px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .preview-header {
            background: #f8f9fa;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-frame {
            width: 100%;
            height: calc(100% - 60px);
            border: none;
            background: white;
        }

        .lesson-content h2 {
            color: #2d3748;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 3px solid #667eea;
        }

        .lesson-content h3 {
            color: #4a5568;
            margin: 1.5rem 0 1rem;
        }

        .lesson-content h4 {
            color: #718096;
            margin: 1rem 0 0.5rem;
        }

        .lesson-content pre {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .lesson-content code {
            background: #edf2f7;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .lesson-content ul, .lesson-content ol {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        .lesson-content li {
            margin: 0.5rem 0;
        }

        .exercise-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .exercise-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .exercise-description {
            color: #4a5568;
            margin-bottom: 1rem;
        }

        .exercise-difficulty {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }

        .difficulty-beginner {
            background: #c6f6d5;
            color: #22543d;
        }

        .difficulty-intermediate {
            background: #fed7d7;
            color: #742a2a;
        }

        .difficulty-advanced {
            background: #fbb6ce;
            color: #702459;
        }

        .timer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #718096;
            font-weight: bold;
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }

        .status-badges {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-warning {
            background: #fefcbf;
            color: #744210;
        }

        .grading-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .grading-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .grading-content {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .score-display {
            text-align: center;
            margin-bottom: 2rem;
        }

        .score-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .score-good {
            color: #22543d;
        }

        .score-needs-work {
            color: #742a2a;
        }

        .score-perfect {
            color: #22543d;
            text-shadow: 0 0 10px #c6f6d5;
        }

        .test-results {
            margin: 1.5rem 0;
        }

        .test-result {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem;
            margin: 0.5rem 0;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
        }

        .test-result.passed {
            background: #f0fff4;
            border-color: #9ae6b4;
        }

        .test-result.failed {
            background: #fff5f5;
            border-color: #feb2b2;
        }

        .test-icon {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .test-result.passed .test-icon {
            color: #22543d;
        }

        .test-result.failed .test-icon {
            color: #742a2a;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                height: auto;
                padding: 1rem;
                gap: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .lesson-nav {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .nav-btn {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }

            .editor-header {
                padding: 0.75rem;
            }

            .editor-actions {
                gap: 0.4rem;
            }

            .action-btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.6rem;
                min-width: 32px;
            }

            .preview-container {
                height: 240px;
            }

            .lesson-panel {
                padding: 1rem;
            }

            .exercise-section {
                padding: 1rem;
            }

            .grading-content {
                margin: 1rem;
                padding: 1.5rem;
            }

            .main-content {
                gap: 1rem;
            }

            #monaco-editor {
                min-height: 300px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0.5rem;
            }

            .main-content {
                padding: 0.5rem;
            }

            .lesson-panel, .coding-panel .editor-container {
                border-radius: 5px;
            }

            .action-btn {
                flex: 1;
                max-width: 48%;
            }

            .editor-actions {
                gap: 0.25rem;
            }

            #lesson-title {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1 id="lesson-title">HTML Journalism Course</h1>
            <div class="lesson-nav">
                <a href="/dashboard.html" class="nav-btn">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <button id="prev-lesson-btn" class="nav-btn" onclick="navigateLesson(-1)">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button id="next-lesson-btn" class="nav-btn" onclick="navigateLesson(1)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
                <span class="timer" id="timer">‚è±Ô∏è 0:00</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="lesson-panel">
            <div class="progress-indicator">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <span id="progress-text">Loading...</span>
            </div>
            
            <div class="status-badges" id="status-badges">
                <!-- Status badges will be populated here -->
            </div>

            <div id="lesson-content" class="lesson-content">
                <!-- Lesson content will be loaded here -->
            </div>

            <div id="exercise-section" class="exercise-section" style="display: none;">
                <div class="exercise-title" id="exercise-title"></div>
                <div class="exercise-difficulty" id="exercise-difficulty"></div>
                <div class="exercise-description" id="exercise-description"></div>
                <div id="exercise-instructions"></div>
            </div>
        </div>

        <div class="coding-panel">
            <div class="editor-container">
                <div class="editor-header">
                    <div class="editor-tabs">
                        <span class="tab-label">HTML Editor</span>
                    </div>
                    <div class="editor-actions">
                        <button class="action-btn" onclick="formatCode()" title="Format Code">
                            <i class="fas fa-indent"></i>
                        </button>
                        <button class="action-btn" onclick="showCheatSheet()" title="HTML Help">
                            <i class="fas fa-question-circle"></i>
                        </button>
                        <button class="action-btn" onclick="resetCode()" title="Reset Code">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button class="action-btn" onclick="runCode()" title="Update Preview">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="action-btn success" id="submit-btn" onclick="submitExercise()" title="Submit for Grading">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </div>
                <div id="monaco-editor"></div>
            </div>

            <div class="preview-container">
                <div class="preview-header">
                    <h4><i class="fas fa-eye"></i> Live Preview</h4>
                    <button class="action-btn" onclick="refreshPreview()">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
                <iframe 
                    id="preview-frame" 
                    class="preview-frame"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"
                    srcdoc="<html><body><p style='color: #666; text-align: center; margin-top: 50px;'>Preview will appear here when you run your code...</p></body></html>">
                </iframe>
            </div>
        </div>
    </div>

    <!-- Grading Modal -->
    <div id="grading-modal" class="grading-modal">
        <div class="grading-content">
            <div class="score-display">
                <div class="score-number" id="score-number">0%</div>
                <p id="score-message">Processing your submission...</p>
            </div>
            <div class="test-results" id="test-results">
                <!-- Test results will be populated here -->
            </div>
            <div style="text-align: center; margin-top: 2rem;">
                <button class="action-btn" onclick="closeGrading()">Continue</button>
                <button class="action-btn success" id="next-lesson-modal-btn" onclick="goToNextLesson()" style="display: none;">
                    Next Lesson
                </button>
            </div>
        </div>
    </div>

    <!-- Monaco Editor -->
    <script src="https://unpkg.com/monaco-editor@0.34.0/min/vs/loader.js"></script>
    
    <script>
        let editor;
        let currentLessonId = 1;
        let currentExerciseIndex = 0;
        let exercises = [];
        let lessonData = null;
        let startTime = Date.now();
        let timeSpent = 0;
        let timerInterval;
        let autoSaveInterval;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get lesson ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentLessonId = parseInt(urlParams.get('lesson')) || 1;
            
            initializeMonacoEditor();
            loadLesson();
            startTimer();
            
            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(autoSave, 30000);
        });

        // Initialize Monaco Editor
        function initializeMonacoEditor() {
            require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.34.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                    value: `<!DOCTYPE html>
<html>
<head>
    <title>My Page</title>
</head>
<body>
    <h1>Hello World!</h1>
</body>
</html>`,
                    language: 'html',
                    theme: 'vs-dark',
                    automaticLayout: true,
                    minimap: { enabled: false },
                    fontSize: 14,
                    fontFamily: 'Monaco, Consolas, monospace',
                    lineNumbers: 'on',
                    wordWrap: 'on',
                    scrollBeyondLastLine: false,
                    autoClosingBrackets: 'always',
                    autoClosingQuotes: 'always',
                    tabSize: 2,
                    insertSpaces: true
                });

                // Auto-save on content change
                editor.onDidChangeModelContent(() => {
                    clearTimeout(window.autoSaveTimeout);
                    window.autoSaveTimeout = setTimeout(() => {
                        updatePreview();
                        autoSave();
                    }, 1000);
                });

                // Update preview initially
                updatePreview();
            });
        }

        // Load lesson from API
        async function loadLesson() {
            try {
                const response = await fetch(`/api/lessons/${currentLessonId}`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load lesson');
                }

                lessonData = data.lesson;
                exercises = data.exercises || [];
                currentExerciseIndex = 0;

                displayLesson();
                displayExercise();
                updateNavigation();
                updateProgress();
                
                // Load saved code if available
                if (exercises[0] && exercises[0].saved_code) {
                    editor.setValue(exercises[0].saved_code);
                } else if (exercises[0] && exercises[0].starter_code) {
                    editor.setValue(exercises[0].starter_code);
                }

            } catch (error) {
                console.error('Failed to load lesson:', error);
                document.getElementById('lesson-content').innerHTML = 
                    `<p style="color: red;">Failed to load lesson: ${error.message}</p>`;
            }
        }

        // Display lesson content
        function displayLesson() {
            document.getElementById('lesson-title').textContent = 
                `Lesson ${lessonData.lesson_number}: ${lessonData.title}`;
            document.getElementById('lesson-content').innerHTML = lessonData.content_html || 
                '<p>Loading lesson content...</p>';
        }

        // Display current exercise
        function displayExercise() {
            const exercise = exercises[currentExerciseIndex];
            const exerciseSection = document.getElementById('exercise-section');
            
            if (!exercise) {
                exerciseSection.style.display = 'none';
                return;
            }

            exerciseSection.style.display = 'block';
            document.getElementById('exercise-title').textContent = exercise.title;
            document.getElementById('exercise-description').textContent = exercise.description;
            document.getElementById('exercise-instructions').innerHTML = exercise.instructions;
            
            const difficultyEl = document.getElementById('exercise-difficulty');
            difficultyEl.textContent = exercise.difficulty;
            difficultyEl.className = `exercise-difficulty difficulty-${exercise.difficulty}`;
        }

        // Update navigation buttons
        function updateNavigation() {
            const prevBtn = document.getElementById('prev-lesson-btn');
            const nextBtn = document.getElementById('next-lesson-btn');
            
            prevBtn.disabled = currentLessonId <= 1;
            nextBtn.disabled = currentLessonId >= 7; // Assuming 7 lessons max
        }

        // Navigate to different lesson
        function navigateLesson(direction) {
            const newLessonId = currentLessonId + direction;
            if (newLessonId >= 1 && newLessonId <= 7) {
                window.location.href = `lesson.html?lesson=${newLessonId}`;
            }
        }

        // Update progress display
        function updateProgress() {
            // This is a simplified progress calculation
            const progressPercent = Math.min(((currentLessonId - 1) / 7) * 100, 100);
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            document.getElementById('progress-text').textContent = 
                `Lesson ${currentLessonId} of 7`;
        }

        // Timer functions
        function startTimer() {
            timerInterval = setInterval(() => {
                timeSpent = Math.floor((Date.now() - startTime) / 1000);
                updateTimerDisplay();
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timeSpent / 3600);
            const minutes = Math.floor((timeSpent % 3600) / 60);
            const seconds = timeSpent % 60;
            
            let timeText = '';
            if (hours > 0) {
                timeText = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            document.getElementById('timer').innerHTML = `‚è±Ô∏è ${timeText}`;
        }

        // Update preview
        function updatePreview() {
            if (!editor) return;
            
            const code = editor.getValue();
            const frame = document.getElementById('preview-frame');
            
            // Use srcdoc for better security and reliability
            try {
                frame.srcdoc = code;
            } catch (e) {
                // Fallback for older browsers
                const blob = new Blob([code], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                frame.src = url;
                
                // Clean up blob URL after a short delay
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
            }
        }

        function refreshPreview() {
            updatePreview();
        }

        // Auto-save function
        async function autoSave() {
            if (!editor) return;
            
            const code = editor.getValue();
            
            try {
                await fetch(`/api/lessons/${currentLessonId}/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, timeSpent })
                });
            } catch (err) {
                console.log('Auto-save failed (offline):', err);
            }
        }

        // Reset code
        function resetCode() {
            if (editor && confirm('Reset your code? This cannot be undone.')) {
                const exercise = exercises[currentExerciseIndex];
                const defaultCode = exercise?.starter_code || `<!DOCTYPE html>
<html>
<head>
    <title>My Page</title>
</head>
<body>
    <h1>Hello World!</h1>
</body>
</html>`;
                editor.setValue(defaultCode);
                updatePreview();
            }
        }

        function runCode() {
            updatePreview();
        }

        // Format the code in the editor
        function formatCode() {
            if (!editor) return;
            editor.trigger('editor', 'editor.action.formatDocument');
        }

        // Show HTML cheat sheet
        function showCheatSheet() {
            const cheatSheet = `
<div style="max-height: 350px; overflow-y: auto; padding: 1rem; font-size: 14px;">
    <h3 style="margin-bottom: 1rem; color: #2d3748;">üìù HTML Quick Reference</h3>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-family: monospace;">
        <div>
            <h4 style="color: #4a5568; margin: 0 0 0.5rem; font-size: 12px;">STRUCTURE</h4>
            <code>&lt;html&gt;</code> - Root element<br>
            <code>&lt;head&gt;</code> - Metadata<br>
            <code>&lt;body&gt;</code> - Content<br>
            <code>&lt;title&gt;</code> - Page title<br><br>
            
            <h4 style="color: #4a5568; margin: 0 0 0.5rem; font-size: 12px;">TEXT</h4>
            <code>&lt;h1&gt;</code> - Main heading<br>
            <code>&lt;h2&gt;</code> - Subheading<br>
            <code>&lt;p&gt;</code> - Paragraph<br>
            <code>&lt;strong&gt;</code> - Bold<br>
            <code>&lt;em&gt;</code> - Italic<br>
        </div>
        <div>
            <h4 style="color: #4a5568; margin: 0 0 0.5rem; font-size: 12px;">MEDIA & LINKS</h4>
            <code>&lt;img src="..." alt="..."&gt;</code><br>
            <code>&lt;a href="..."&gt;Link&lt;/a&gt;</code><br>
            <code>&lt;figure&gt;&lt;figcaption&gt;</code><br><br>
            
            <h4 style="color: #4a5568; margin: 0 0 0.5rem; font-size: 12px;">LISTS</h4>
            <code>&lt;ul&gt;&lt;li&gt;Item&lt;/li&gt;&lt;/ul&gt;</code><br>
            <code>&lt;ol&gt;&lt;li&gt;Item&lt;/li&gt;&lt;/ol&gt;</code><br><br>
            
            <h4 style="color: #4a5568; margin: 0 0 0.5rem; font-size: 12px;">NEWS</h4>
            <code>&lt;article&gt;</code> - Article<br>
            <code>&lt;blockquote&gt;</code> - Quote<br>
            <code>&lt;nav&gt;</code> - Navigation<br>
        </div>
    </div>
</div>
            `;
            
            // Create or update cheat sheet modal
            let modal = document.getElementById('cheat-sheet-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'cheat-sheet-modal';
                modal.className = 'grading-modal';
                modal.innerHTML = `
                    <div class="grading-content">
                        ${cheatSheet}
                        <div style="text-align: center; margin-top: 1.5rem;">
                            <button class="action-btn" onclick="closeCheatSheet()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            modal.classList.add('show');
        }

        function closeCheatSheet() {
            const modal = document.getElementById('cheat-sheet-modal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Submit exercise for grading
        async function submitExercise() {
            if (!editor) return;

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.textContent = '‚è≥ Grading...';
            submitBtn.disabled = true;

            const code = editor.getValue();
            const exercise = exercises[currentExerciseIndex];
            
            try {
                // Grade using the exercise's test cases
                const gradeResult = await gradeSubmission(code, exercise);
                
                // Show results
                showGradingResults(gradeResult);
                
                // Save submission
                await saveSubmission(exercise.id, code, gradeResult);
                
                // Update time spent
                await updateTimeSpent();
                
            } catch (error) {
                console.error('Grading failed:', error);
                alert('Grading failed. Please try again.');
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit & Grade';
                submitBtn.disabled = false;
            }
        }

        // Grade submission using test cases
        async function gradeSubmission(code, exercise) {
            const testCases = exercise.test_cases || [];
            let totalScore = 0;
            const results = [];

            for (const testCase of testCases) {
                const passed = runTestCase(code, testCase);
                results.push({
                    name: testCase.test_type,
                    passed: passed,
                    points: passed ? testCase.points : 0,
                    error_message: testCase.error_message
                });
                
                if (passed) {
                    totalScore += testCase.points;
                }
            }

            const maxScore = testCases.reduce((sum, tc) => sum + tc.points, 0);
            const percentage = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
            const passed = percentage >= 70;

            return {
                totalScore,
                maxScore,
                percentage,
                passed,
                tests: results,
                feedback: passed ? 
                    `Excellent! You scored ${percentage}%. You can proceed to the next exercise.` : 
                    `You scored ${percentage}%. You need 70% to pass. Review the requirements and try again.`
            };
        }

        // Run individual test case
        function runTestCase(code, testCase) {
            const config = testCase.test_config;
            
            switch (testCase.test_type) {
                case 'html_tag_exists':
                    return code.includes(`<${config.tag}>`);
                
                case 'html_tag_count':
                    const regex = new RegExp(`<${config.tag}[\\s>]`, 'g');
                    const matches = code.match(regex) || [];
                    const count = matches.length;
                    
                    switch (config.operator) {
                        case 'gte': return count >= config.count;
                        case 'lte': return count <= config.count;
                        case 'eq': return count === config.count;
                        default: return count >= config.count;
                    }
                
                case 'attribute_exists':
                    const attrRegex = new RegExp(`<${config.tag}[^>]*${config.attribute}\\s*=`, 'i');
                    return attrRegex.test(code);
                
                default:
                    return false;
            }
        }

        // Show grading results
        function showGradingResults(result) {
            document.getElementById('score-number').textContent = `${result.percentage}%`;
            document.getElementById('score-number').className = `score-number ${
                result.percentage === 100 ? 'score-perfect' :
                result.percentage >= 70 ? 'score-good' : 'score-needs-work'
            }`;
            
            document.getElementById('score-message').textContent = result.feedback;
            
            // Show test results
            const testResults = document.getElementById('test-results');
            testResults.innerHTML = result.tests.map(test => `
                <div class="test-result ${test.passed ? 'passed' : 'failed'}">
                    <span class="test-icon">${test.passed ? '‚úì' : '‚úó'}</span>
                    <div>
                        <div>${test.error_message || test.name}</div>
                        <small>${test.points}/${test.points} points</small>
                    </div>
                </div>
            `).join('');

            // Show next lesson button if passed
            if (result.passed) {
                document.getElementById('next-lesson-modal-btn').style.display = 'inline-block';
            }

            document.getElementById('grading-modal').classList.add('show');
        }

        // Close grading modal
        function closeGrading() {
            document.getElementById('grading-modal').classList.remove('show');
        }

        // Go to next lesson
        function goToNextLesson() {
            navigateLesson(1);
        }

        // Save submission to database
        async function saveSubmission(exerciseId, code, gradeResult) {
            try {
                await fetch('/api/exercises/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exerciseId: exerciseId,
                        code: code,
                        score: gradeResult.totalScore,
                        maxScore: gradeResult.maxScore,
                        isComplete: gradeResult.passed,
                        feedback: gradeResult
                    })
                });
            } catch (error) {
                console.error('Failed to save submission:', error);
            }
        }

        // Update time spent
        async function updateTimeSpent() {
            try {
                await fetch('/api/progress/time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        lessonId: currentLessonId, 
                        seconds: timeSpent 
                    })
                });
            } catch (error) {
                console.error('Failed to update time:', error);
            }
        }

        // Pause timer when page is not visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(timerInterval);
                autoSave();
            } else {
                startTime = Date.now() - (timeSpent * 1000);
                startTimer();
            }
        });

        // Save progress before leaving page
        window.addEventListener('beforeunload', () => {
            autoSave();
        });
    </script>
</body>
</html>